---
title: 深入java并发
date: 2018-03-01 15:15:40
categories: Java
tags:
- 并发
- 锁
---

随着CPU核心的价格越来越低，多核时代来临。为了充分发挥多核CPU的优势，各大编程语言纷纷对多线程进行了支持，比如Java。特别是在大规模，高并发的web开发中，为了提高系统吞吐率和资源利用率，多线程不和避免，同时我们所使用的各种开源框架基本上都是多线程。但是多线程比单线程要更加复杂，我们必须保证其线程安全性，这就需要用到java中同步和锁。但这些总归只是一些机制，要编写线程安全的代码，其核心在于要对状态访问操作进行管理，我们需要理解对象是否有状态，状态是否可变，可变是否共享，是读操作还是写操作。

#### 对象的状态

线程同步代码是复杂的，并且往往会抑制某些编译器优化，造成额外的性能开销，比如使内存缓存区的数据失效，以及增加共享内存总线的同步流量，最重要它会使并行的流程降级成串行的，这与我们引入多线程的初衷相悖。因此除了对同步机制进行优化外，更好的方法是尽量避免线程同步。那么如何避免呢？我们首先需要理解需要线程同步的那些线程共享的，并且可变的对象。因此我们应该根据需求尽可能的构造无状态的对象，有状态但不可变的对象，可变的但是是线程私有的对象。同时可变的，共享的，但是只有读操作的我们也不需要对它进行额外的同步操作。下面逐一对这些对象进行讲解。

- 无状态的对象

只有成员方法没有属性的对象。（线程安全）

- 有状态的但不可变的对象

有成员属性，但属性不可变或者事实不可变的对象。（线程安全）

- 有状态的，可变的，但是线程私有的对象

有成员属性，并且可变，但这个对象是在一个线程流程内部（可以理解为线程下游的函数内）创建的，此时对它的非静态成员的访问是不需要做额外的线程同步的。（要确保该对象的依赖对象也是线程私有的）

- 有状态的，可变的，同时又是线程共享的对象

有成员属性，并且可变，同时多个线程都可访问这个对象。（线程不安全，需要额外的同步机制）

#### 保证线程安全性的机制

要想保证线程安全性，就要同时保证操作的原子性和可见性。

##### 原子性

###### 内置锁

原子性的类，可重入

###### 显示锁

##### 可见性

#### 锁

#### Java并发框架

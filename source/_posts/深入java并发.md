---
title: 深入java并发
date: 2018-03-01 15:15:40
categories: Java
tags:
- 并发
- 锁
---

随着CPU核心的价格越来越低，多核时代来临。为了充分发挥多核CPU的优势，各大编程语言纷纷对多线程进行了支持，比如Java。特别是在大规模，高并发的web开发中，为了提高系统吞吐率和资源利用率，多线程不和避免，同时我们所使用的各种开源框架基本上都是多线程。但是多线程比单线程要更加复杂，我们必须保证其线程安全性，这就需要用到java中同步和锁。但这些总归只是一些机制，要编写线程安全的代码，其核心在于要对状态访问操作进行管理，我们需要理解对象是否有状态，状态是否可变，可变是否共享，是读操作还是写操作。

#### 对象的状态

线程同步代码是复杂的，并且往往会抑制某些编译器优化，造成额外的性能开销，比如使内存缓存区的数据失效，以及增加共享内存总线的同步流量，最重要它会使并行的流程降级成串行的，这与我们引入多线程的初衷相悖。因此除了对同步机制进行优化外，更好的方法是尽量避免线程同步。那么如何避免呢？我们首先需要理解需要线程同步的那些线程共享的，并且可变的对象。因此我们应该根据需求尽可能的构造无状态的对象，有状态但不可变的对象，可变的但是是线程私有的对象。同时可变的，共享的，但是只有读操作的我们也不需要对它进行额外的同步操作。下面逐一对这些对象进行讲解。

- 无状态的对象

只有成员方法没有属性的对象。（线程安全）

- 有状态的但不可变的对象

有成员属性，但属性不可变或者事实不可变的对象。（线程安全）

- 有状态的，可变的，但是线程私有的对象

有成员属性，并且可变，但这个对象是在一个线程流程内部（可以理解为线程下游的函数内）创建的，此时对它的非静态成员的访问是不需要做额外的线程同步的。（要确保该对象的依赖对象也是线程私有的）

- 有状态的，可变的，同时又是线程共享的对象

有成员属性，并且可变，同时多个线程都可访问这个对象。（线程不安全，需要额外的同步机制）

#### 影响线程安全的因素

我们总会用到可变的有需要共享的对象，此时要想保证线程安全性，就需要对它进行额外的同步机制。主要就是保证操作的原子性和可见性。

###### 原子性

该原子性与数据库事务中的原子性概念基本是一致的，主要就是描述操作的不可分割性。要么不做，要么全做完。我们来看看下面这段代码：

```java
public class ClassA {
  private int count;

  public int increment() {
    return ++count;
  }
}

```

这是笔者随手写的代码，比较简单，主要用于说明原子性这个概念。我们首先来分析一下这段代码，首先count是成员变量，可变；如果该类所对应的某个对象又是在多个线程之间共享的话，那么这段就可能会出问题。因为count++这个操作不是原子的，它分为读-改-写三个操作，如果第一个线程在读改之后还没有写入内存，第二个线程就已经开始读了，那么此时读到的数据就是无效的。当然是否会读到无效数据完全是无法确定的，它可能读对，也可能读错，不确定性正是多线程程序复杂性之一。此时我们就需要额外的同步机制，比如锁，锁这个东西我们之后再说，下面看一下影响线程安全性的另一个因素，可见性。

###### 可见性

可见性是要保证一个线程在对变量修改之后其他线程能立刻可见，要保证可见性，我们需要明白为什么在单线程环境中可见的数据在多线程中就不再可见了。这是由于在多线程环境中，各个线程之间不止会共享内存的数据，它们还会有自己单独的工作内存，比如寄存器。这些工作内存中保存着主内存中数据的副本，线程在修改数据时会先修改自己的工作内存中的数据，然后再同步回主存，其他线程再从主存中更新数据。这样当一个线程在修改自己的副本后没有同步回主存或者不够及时，其他线程就会拿到一个失效的值。

java中内存可见性是通过volatile关键字实现的。它使得线程在修改它所修饰的变量时会直接写入主存，而不会先修改自己的本地副本。其实volatile不止保证了内存可见性，还防止了指令重排序。至于什么是重排序，volatile又是如何防止指令重排（通过构造内存屏障）的读者可以查阅其他的资料了解。反正挺复杂的，笔者在阅读之后不禁又再次萌生了转行的年头。咱们这行当牛人无数，竞争激烈还得学无止境，太难了。完全没有时间去缅怀一下初恋，或者感受下身边的生活。

#### 锁

java保证线程安全的机制便是通过加锁，java中的锁是比volatile关键字更高一级的线程同步机制，它不止能保证内存可见性，还能保证原子性。一般在保证线程安全性上基本上都是使用锁，volatile关键字的使用场景其实很苛刻，并不常用。下面列举下java中的几种加锁机制。

###### 内置锁



#### Java并发框架
